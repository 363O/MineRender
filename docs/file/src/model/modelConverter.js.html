<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/model/modelConverter.js | MineRender</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Documentation for MineRender, quick, easy, interactive Minecraft renders"><meta property="og:type" content="website"><meta property="og:url" content="https://minerender.org"><meta property="og:site_name" content="MineRender"><meta property="og:title" content="MineRender"><meta property="og:image" content="https://minerender.org/img/minerender-x256.png"><meta property="og:description" content="Documentation for MineRender, quick, easy, interactive Minecraft renders"><meta property="og:author" content="inventivetalent"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="MineRender"><meta property="twitter:description" content="Documentation for MineRender, quick, easy, interactive Minecraft renders"><meta property="twitter:image" content="https://minerender.org/img/minerender-x256.png"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./" style="display: flex; align-items: center;"><img src="./image/brand_logo.png" style="width:34px;"></a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/InventivetalentDev/MineRender"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/renderBase.js~Render.html">Render</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadBlockState">loadBlockState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadJsonFromPath">loadJsonFromPath</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadTextureAsBase64">loadTextureAsBase64</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadTextureMeta">loadTextureMeta</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-scaleUv">scaleUv</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-trimCanvas">trimCanvas</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deepDisposeMesh">deepDisposeMesh</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mergeCubeMeshes">mergeCubeMeshes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mergeMeshes__">mergeMeshes__</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_ROOT">DEFAULT_ROOT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-defaultOptions">defaultOptions</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#combined">combined</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/combined/index.js~CombinedRender.html">CombinedRender</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#entity">entity</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/entity/index.js~EntityRender.html">EntityRender</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#gui">gui</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/gui/index.js~GuiRender.html">GuiRender</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-guiHelper">guiHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-guiPositions">guiPositions</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#lib">lib</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-OrbitControls">OrbitControls</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#model">model</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/index.js~ModelRender.html">ModelRender</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-worker">worker</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ModelConverter">ModelConverter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deleteObjectProperties">deleteObjectProperties</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-findMatchingVariant">findMatchingVariant</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadAndMergeModel">loadAndMergeModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadModel">loadModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadTextures">loadTextures</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mergeParents">mergeParents</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-modelCacheKey">modelCacheKey</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseModel">parseModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseModelType">parseModelType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-toRadians">toRadians</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-variantStringToObject">variantStringToObject</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#skin">skin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/skin/index.js~SkinRender.html">SkinRender</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-texturePositions">texturePositions</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/model/modelConverter.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import * as pako from &quot;pako&quot;;
import * as NBT from &quot;prismarine-nbt&quot;;
import SkinRender from &quot;../skin/index&quot;;
import { loadBlockState } from &quot;../functions&quot;;

/**
 * Helper to convert multi-block structures to models used by {@link ModelRender}
 * @constructor
 */
function ModelConverter() {
}

/**
 * Converts a {@link https://minecraft.gamepedia.com/Structure_block_file_format|Minecraft structure file} to models
 * @param {object} structure structure file info
 * @param {string} structure.url URL to a structure file
 * @param {(Blob|File)} structure.file uploaded file
 * @param {(Uint8Array|ArrayBuffer)} structure.raw Raw NBT data
 * @param cb
 */
ModelConverter.prototype.structureToModels = function (structure, cb) {
    loadNBT(structure).then((rawNbt) =&gt; {
        NBT.parse(rawNbt, (err, data) =&gt; {
            if (err) {
                console.warn(&quot;Error while parsing NBT data&quot;);
                console.warn(err);
                return;
            }

            if (!PRODUCTION) {
                console.log(&quot;NBT Data:&quot;)
                console.log(data);
            }

            parseStructureData(data).then((data) =&gt; {
                cb(data);
            })
        })
    })
};


/**
 * Converts a Minecraft schematic file to models
 * @param {object} schematic structure file info
 * @param {string} schematic.url URL to a structure file
 * @param {(Blob|File)} schematic.file uploaded file
 * @param {(Uint8Array|ArrayBuffer)} schematic.raw Raw NBT data
 * @param cb
 */
ModelConverter.prototype.schematicToModels = function (schematic, cb) {
    loadNBT(schematic).then(rawNbt =&gt; {
        NBT.parse(rawNbt, (err, data) =&gt; {
            if (err) {
                console.warn(&quot;Error while parsing NBT data&quot;);
                console.warn(err);
                return;
            }

            if (!PRODUCTION) {
                console.log(&quot;NBT Data:&quot;)
                console.log(data);
            }

            let xhr = new XMLHttpRequest();
            xhr.open(&apos;GET&apos;, &quot;https://minerender.org/res/idsToNames.json&quot;, true);
            xhr.onloadend = function () {
                if (xhr.status === 200) {
                    console.log(xhr.response || xhr.responseText);

                    let idsToNames = JSON.parse(xhr.response || xhr.responseText);
                    parseSchematicData(data, idsToNames).then(data =&gt; cb(data));
                }
            };
            xhr.send();

        })
    })
};


function loadNBT(source) {
    return new Promise((resolve, reject) =&gt; {
        if (source.file) {
            let reader = new FileReader();
            reader.onload = function () {
                let arrayBuffer = this.result;
                let array = new Uint8Array(arrayBuffer);

                resolve(array);
            }
            reader.readAsArrayBuffer(source.file);
        } else if (source.url) {
            let xhr = new XMLHttpRequest();
            xhr.open(&apos;GET&apos;, source.url, true);
            xhr.responseType = &apos;arraybuffer&apos;;
            xhr.onloadend = function () {
                if (xhr.status === 200) {
                    let array = new Uint8Array(xhr.response || xhr.responseText);

                    resolve(array);
                }
            };
            xhr.send();
        } else if (source.raw) {
            if (source.raw instanceof Uint8Array) {
                resolve(source.raw)
            } else {
                resolve(new Uint8Array(source.raw));
            }
        } else {
            reject();
        }
    })
}

function parseStructureData(data, paletteIndex) {
    return new Promise((resolve, reject) =&gt; {
        if (data.type === &quot;compound&quot;) {
            if (data.value.hasOwnProperty(&quot;blocks&quot;) &amp;&amp; (data.value.hasOwnProperty(&quot;palette&quot;) || data.value.hasOwnProperty(&quot;palettes&quot;))) {
                let originalPalette;
                if (data.value.hasOwnProperty(&quot;palette&quot;)) {
                    originalPalette = data.value[&quot;palette&quot;].value.value;
                } else {
                    if (typeof paletteIndex === &quot;undefined&quot;) paletteIndex = 0;
                    if (paletteIndex &gt;= data.value[&quot;palettes&quot;].value.value.length || !data.value[&quot;palettes&quot;].value.value[paletteIndex]) {
                        console.warn(&quot;Specified palette index (&quot; + paletteIndex + &quot;) is outside of available palettes (&quot; + data.value[&quot;palettes&quot;].value.value.length + &quot;)&quot;)
                        return;
                    }
                    originalPalette = data.value[&quot;palettes&quot;].value.value[paletteIndex].value;
                }


                // Simplify palette
                let palette = [];
                for (let i = 0; i &lt; originalPalette.length; i++) {
                    palette.push(originalPalette[i]);
                }

                let arr = [];

                // Iterate blocks
                let blocks = data.value.blocks.value.value;
                for (let i = 0; i &lt; blocks.length; i++) {
                    let blockType = palette[blocks[i].state.value].Name.value;
                    if (blockType === &quot;minecraft:air&quot;) {
                        // No need to add air
                        continue;
                    }
                    let shortBlockType = blockType.substr(&quot;minecraft:&quot;.length);

                    let pos = blocks[i].pos.value.value;

                    let multipartConditions = {};

                    let variantString = &quot;&quot;;
                    if (palette[blocks[i].state.value].hasOwnProperty(&quot;Properties&quot;)) {
                        let strs = [];
                        for (let p in  palette[blocks[i].state.value].Properties.value) {
                            if (palette[blocks[i].state.value].Properties.value.hasOwnProperty(p)) {
                                let prop = palette[blocks[i].state.value].Properties.value[p];

                                strs.push(p + &quot;=&quot; + prop.value);

                                multipartConditions[p] = prop.value;
                            }
                        }

                        // Make sure the variants are sorted properly, or it won&apos;t match the game files
                        strs.sort();

                        for (let i = 0; i &lt; strs.length; i++) {
                            variantString += &quot;,&quot; + strs[i];
                        }

                        variantString = variantString.substr(1);
                    }

                    if (specialVariants.hasOwnProperty(shortBlockType)) {
                        shortBlockType = specialVariants[shortBlockType](palette[blocks[i].state.value].Properties.value);
                        variantString = &quot;&quot;;
                    }

                    let block = {
                        blockstate: shortBlockType,
                        variant: variantString,
                        multipart: multipartConditions,
                        offset: [pos[0] * 16, pos[1] * 16, pos[2] * 16]
                    };
                    arr.push(block)
                }

                resolve(arr);
            } else {
                console.warn(&quot;Invalid NBT - Missing blocks/palette(s)&quot;);
                reject();
            }
        } else {
            console.warn(&quot;Invalid NBT - Root tag should be compound&quot;);
            reject();
        }
    })
}

function parseSchematicData(data, idToNameMap) {
    return new Promise((resolve, reject) =&gt; {
        let width = data.value.Width.value;
        let height = data.value.Height.value;
        let length = data.value.Length.value;

        let infoAt = function (x, y, z) {
            let index = (y * length + z) * width + x;
            return {
                id: data.value.Blocks.value[index],
                data: data.value.Data.value[index]
            }
        };

        let convertLegacy = function (id, data) {
            let mapped = idToNameMap.blocks[id + &quot;:&quot; + data];
            if (!mapped) {
                console.warn(&quot;Missing legacy mapping for &quot; + id + &quot;:&quot; + data);
                return &quot;minecraft:air&quot;;
            }
            return mapped;
        };

        let arr = [];

        for (let y = 0; y &lt; height; y++) {
            for (let x = 0; x &lt; width; x++) {
                for (let z = 0; z &lt; length; z++) {
                    let info = infoAt(x, y, z);
                    let convertedInfo = convertLegacy(info.id, info.data);

                    let infoSplit = convertedInfo.replace(&quot;minecraft:&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;).split(&quot;[&quot;);
                    let shortName = infoSplit[0];
                    let variantString = infoSplit[1] || &quot;&quot;;

                    if (shortName === &quot;air&quot;) continue;

                    if (variantString !== &quot;&quot;) {
                        variantString = variantString.split(&quot;,&quot;).sort().join(&quot;,&quot;);
                    }

                    arr.push({
                        blockstate: shortName,
                        variant: variantString,
                        offset: [x * 16, y * 16, z * 16]
                    });
                }
            }
        }

        resolve(arr);
    })
}

let specialVariants = {
    &quot;stained_glass&quot;: function (properties) {
        return properties.color.value + &quot;_stained_glass&quot;;
    },
    &quot;planks&quot;: function (properties) {
        return properties.variant.value + &quot;_planks&quot;;
    }
};


ModelConverter.prototype.constructor = ModelConverter;

window.ModelConverter = ModelConverter;

export default ModelConverter;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
